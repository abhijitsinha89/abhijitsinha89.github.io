'use strict';

var app = angular.module('app', [
    'ngRoute',
    'ngSanitize'
]);
app.constant('routes', getRoutes());

// Configure the routes and route resolvers
app.config(['$routeProvider', '$locationProvider', 'routes', routeConfigurator]);
function routeConfigurator($routeProvider,$locationProvider, routes) {

    routes.forEach(function (r) {
        $routeProvider.when(r.url, r.config);
    });
    $routeProvider.otherwise({ redirectTo: '/' });

}

// Define the routes
function getRoutes() {
    return [
        {
            url: '/',
            config: {
                title: 'home',
                templateUrl:  'app/drag/drag.html'
            }
        },
        {
            url: '/upload-drag',
            config: {
                title: 'upload-drag',
                templateUrl:  'app/upload-drag/upload-drag.html'
            }
        }
    ];
}
app.directive('dragSwapFiles', function() {
	return {
		restrict: 'A',
		scope: {
			file: '=',
			fileName: '='
		},
		link: function(scope, element, attrs) {
			var dragover, dragenter,
			dragStart,dragLeave, drop;
			window.currentDraggedElement = null;

			dragover = function(event) {
				if (event !== null) {
					event.preventDefault();
					event.dataTransfer.effectAllowed = 'move';
				}
			};

			dragenter = function(event) {
				if (event !== null) {
					event.preventDefault();
					this.classList.add("active-drop");
				}
			};

			dragLeave = function (event) {
				if (event !== null) {
					event.preventDefault();
					this.classList.remove("active-drop");
				}
			};

			 dragStart = function(event) {
				event.dataTransfer.setData("src", this.innerHTML);
				this.classList.add('draggableElement');
				currentDraggedElement = this;
			};

			drop = function(event) {
				event.preventDefault();
				if (currentDraggedElement !== this) {
					var that = this;
					currentDraggedElement.classList.remove('draggableElement');
					currentDraggedElement.innerHTML = this.innerHTML;
					this.classList.remove("active-drop");
    				this.innerHTML = event.dataTransfer.getData('src');
    				this.classList.add('set-element-after-drop');
    				setTimeout(function(){ that.classList.remove('set-element-after-drop'); }, 1000);
				}
			};

			element.bind('dragover', dragover);
			element.bind('dragenter', dragenter);
			element.bind('dragstart', dragStart);
			element.bind('dragleave', dragLeave);
			element.bind('drop', drop);
		}
	};
});

app.directive('dragImageFiles', function() {
	return {
		restrict: 'A',
		scope: {
			file: '=',
			fileName: '='
		},
		link: function(scope, element, attrs) {
			var isTypeValid,
			dragenter,dragover,drop,
			validMimeTypes = attrs.dragImageFiles;

			dragenter = function(event) {
				if (event !== null) {
					event.preventDefault();
					event.dataTransfer.effectAllowed = 'copy';
				}
			};

			dragover = function(event) {
				if (event !== null) {
					event.preventDefault();
					event.dataTransfer.effectAllowed = 'copy';
				}
			};

			drop = function(event) {
				var file, name, reader, size, type;

				if (event !== null) {
					event.preventDefault();

					reader = new FileReader();

					file = event.dataTransfer.files[0];
					reader.readAsDataURL(file);
					name = file.name;
					type = file.type;
					size = file.size;

					reader.onload = function(evt) {
						if (isTypeValid(type)) {
							return scope.$apply(function() {
								scope.file = evt.target.result;
								element.addClass('lowerZindex');
								return scope.fileName = name;
							});
						}
					};
					return false;
				}
			};

			isTypeValid = function(type) {
				if (validMimeTypes.indexOf(type) > -1) {
					return true;
				}
				else {
					alert('Invalid file type, file must be one of following types ' + validMimeTypes);
					return false;
				}
			};

			element.bind('dragover', dragover);
			element.bind('dragenter', dragenter);
			element.bind('drop', drop);

		}
	};
});

app.service('UpdateImage', [ '$http', function($http) {

var createImage = function (newImage) {
        return {
            orderId: newImage.orderId,
            label: newImage.label,
            fileName: newImage.fileName
        };
    },
    images;

this.updateImageObject = function (imageDetails) {
    if(images[imageDetails.orderId]) {
        images[imageDetails.orderId].fileName =  imageDetails.fileName;
    }
}

this.createNewImage = function (imageDetails) {
    if(!images[imageDetails.orderId]) {
        images[imageDetails.orderId] =  createImage(imageDetails);
    }
}

}]);
app.controller('Upload', ['$scope', '$http', function($scope, $http) {
   $scope.imagePlaceholder = ['View 1','View 2','View 3','View 4','View 5', 'View 6'];
   $scope.image = null;
    $scope.imageFileName = '';
}]);
app.controller('Upload', ['$scope', '$http', function($scope, $http) {
   $scope.imagePlaceholder = ['View 1','View 2','View 3','View 4','View 5', 'View 6'];
   $scope.image = null;
    $scope.imageFileName = '';
}]);